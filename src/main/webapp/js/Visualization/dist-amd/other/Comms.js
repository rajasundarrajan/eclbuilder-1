(function(e,t){typeof define=="function"&&define.amd?define(["es6-promise"],t):e.other_Comms=t()})(this,function(){function e(e){if(e===undefined||e===null)return null;if(!e.trim)return e;var t=e.trim();return t!==""&&!isNaN(t)?Number(t):t}function t(t){for(var n in t)t[n]=e(t[n]);return t}function n(){this._protocol="http:",this._hostname="localhost"}function r(e){this._mappings=e,this._reverseMappings={};for(var t in this._mappings){this._reverseMappings[t]={};for(var n in this._mappings[t])this._reverseMappings[t][this._mappings[t][n]]=n}}function i(){n.call(this),this._proxyMappings={},this._mappings=new r({}),this._timeout=60}function s(e,t){if(!e||!t)return!1;var n=e.split("."),r=t;for(var i=0;i<n.length;++i){var s=n[i];if(r[s]===undefined)return!1;r=r[s]}return!0}function u(){i.call(this)}function a(){i.call(this),this._port="8002",this._target="",this._query=""}function f(){i.call(this),this._port="8010",this._wuid="",this._jobname="",this._sequence=null,this._resultName=null,this._resultNameCache={},this._resultNameCacheCount=0}function l(){i.call(this),this._port="8010",this._wuid=null}function c(){i.call(this)}function h(){f.call(this),this._hipieResults={}}function p(){h.call(this)}n.prototype.url=function(e){if(!arguments.length)return this._url;this._url=e;var t=document.createElement("a");t.href=this._url,t.href=t.href;var n={};if(t.search.length){var r=t.search;r[0]==="?"&&(r=r.substring(1)),r=r.split("&"),r.map(function(e){var t=e.split("=");n[decodeURIComponent(t[0])]=decodeURIComponent(t[1])})}this._protocol=t.protocol,this._hostname=t.hostname,this._port=t.port,this._pathname=t.pathname;while(this._pathname.length&&this._pathname[0]==="/")this._pathname=this._pathname.substring(1);return this._search=t.search,this._params=n,this._hash=t.hash,this._host=t.host,this},n.prototype.protocol=function(e){return arguments.length?(this._protocol=e,this):this._protocol},n.prototype.hostname=function(e){return arguments.length?(this._hostname=e,this):this._hostname},n.prototype.port=function(e){return arguments.length?(this._port=e,this):this._port},n.prototype.pathname=function(e){return arguments.length?(this._pathname=e,this):this._pathname},n.prototype.isWsWorkunits=function(){return this._pathname.toLowerCase().indexOf("wsworkunits")>=0||this._params.Wuid},n.prototype.isWorkunitResult=function(){return this.isWsWorkunits()&&(this._params.Sequence||this._params.ResultName)},n.prototype.isWsEcl=function(){return this._pathname.toLowerCase().indexOf("wsecl")>=0||this._params.QuerySetId&&this._params.Id},n.prototype.isWsWorkunits_GetStats=function(){return this._pathname.toLowerCase().indexOf("wsworkunits/wugetstats")>=0&&this._params.WUID},n.prototype.getUrl=function(e){return e=e||{},(e.protocol?e.protocol:this._protocol)+"//"+(e.hostname?e.hostname:this._hostname)+":"+(e.port?e.port:this._port)+"/"+(e.pathname?e.pathname:this._pathname)},r.prototype.contains=function(e,t){return s(e+"."+t,this._mappings)},r.prototype.mapResult=function(e,t){var n=this._mappings[t];n&&(e[t]=e[t].map(function(e){var t=[];if(n.x&&n.x instanceof Array){t=[];for(var r=0;r<n.x.length;++r)t.push(e[n.y[r]])}else for(var i in n)n[i]==="label"?t[0]=e[i]:n[i]==="weight"&&(t[1]=e[i]);return t},this))},r.prototype.mapResponse=function(e){for(var t in e)this.mapResult(e,t)},i.prototype=Object.create(n.prototype);var o=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};return i.prototype.jsonp=function(e,t,r){var i=this;return new Promise(function(s,u){function g(e){delete window[d],document.body.removeChild(v),r&&(console.log("Deprecated:  callback, use promise (Comms.prototype.jsonp)"),r(e))}for(var a in i._proxyMappings){var f=e.split(a),l=f[0];if(f.length>1){var c=(new n).url(e);e=l+i._proxyMappings[a],t.IP=c._hostname,t.PORT=c._port,f.length>0&&(t.PATH=f[1]);break}}var h=i.timeout()*1e3,p=5e3,d="jsonp_callback_"+Math.round(Math.random()*999999);window[d]=function(e){h=0,g(e),s(e)};var v=document.createElement("script");v.src=e+(e.indexOf("?")>=0?"&":"?")+"jsonp="+d+"&"+o(t),document.body.appendChild(v);var m=setInterval(function(){h<=0?clearInterval(m):(h-=p,h<=0?(clearInterval(m),console.log("Request timeout:  "+v.src),g(),u(Error("Request timeout:  "+v.src))):console.log("Request pending ("+h/1e3+" sec):  "+v.src))},p)})},i.prototype.ajax=function(e,t,n){return new Promise(function(r,i){var s=t;n&&(s+="?"+o(n));var u=new XMLHttpRequest;u.onload=function(e){this.status>=200&&this.status<300?r(JSON.parse(this.response)):i(Error(this.statusText))},u.onerror=function(){i(Error(this.statusText))},u.open(e,s),u.setRequestHeader("X-Requested-With","XMLHttpRequest"),u.send()})},i.prototype.get=function(e,t){return this.ajax("GET",e,t)},i.prototype.post=function(e,t){return this.ajax("POST",e,t)},i.prototype.mappings=function(e){return arguments.length?(this._mappings=new r(e),this):this._mappings},i.prototype.proxyMappings=function(e){return arguments.length?(this._proxyMappings=e,this):this._proxyMappings},i.prototype.timeout=function(e){return arguments.length?(this._timeout=e,this):this._timeout},u.prototype=Object.create(i.prototype),u.prototype.cacheCalls=function(e){return arguments.length?(this._cacheCalls=e,this):this._cacheCalls},u.prototype.call=function(e,t){var n=this._url+(this._url.indexOf("?")>=0?"&":"?")+o(e);if(this._cacheCalls){var r=this;return(new Promise(function(e,r){var i=JSON.parse(localStorage.getItem("hpcc.viz."+n));if(!i)throw Error("not cached");t&&(console.log("Deprecated:  callback, use promise (Basic.prototype.call)"),t(i)),e(i)})).catch(function(e){return r.get(n).then(function(e){return localStorage.setItem("hpcc.viz."+n,JSON.stringify(e)),t&&(console.log("Deprecated:  callback, use promise (Basic.prototype.call)"),t(e)),e})})}return localStorage.removeItem("hpcc.viz."+n),this.get(n).then(function(e){return t&&(console.log("Deprecated:  callback, use promise (Basic.prototype.call)"),t(e)),e})},a.prototype=Object.create(i.prototype),a.prototype.url=function(e){var t=i.prototype.url.apply(this,arguments);if(arguments.length){this._port=this._port==="8010"?"8002":this._port;for(var n in this._params)switch(n){case"QuerySetId":this.target(this._params[n]);break;case"Id":this.query(this._params[n])}var r,s;!this._target&&!this._query&&(r=this._pathname.split("/res/"),r.length>=2&&(s=r[1].split("/"),s.length>=3&&(this.target(s[1]),this.query(s[2])))),!this._target&&!this._query&&(r=this._pathname.split("/forms/default/"),r.length>=2&&(s=r[1].split("/"),s.length>=3&&(this.target(s[1]),this.query(s[2]))))}return t},a.prototype.target=function(e){return arguments.length?(this._target=e,this):this._target},a.prototype.query=function(e){return arguments.length?(this._query=e,this):this._query},a.prototype.constructUrl=function(){return i.prototype.getUrl.call(this,{pathname:"WsEcl/submit/query/"+this._target+"/"+this._query+"/json"})},a.prototype.call=function(e,n,r){e=e||{},e.target=e.target||this._target,e.query=e.query||this._query;var i=this,s=this.getUrl({pathname:"WsEcl/submit/query/"+e.target+"/"+e.query+"/json"});return this.jsonp(s,n).then(function(e){for(var n in e){e=e[n].Results;break}if(e.Exception)throw Error(e.Exception.reduce(function(e,t,n,r){return e.length&&(e+="\n"),e+t.Source+" "+t.Code+":  "+t.Message},""));for(n in e)e[n].Row&&(e[n]=e[n].Row.map(t));return i._mappings.mapResponse(e),r&&(console.log("Deprecated:  callback, use promise (WsECL.prototype.call)"),r(e)),e})},a.prototype.send=function(e,t){this.call({target:this._target,query:this._query},e,t)},f.prototype=Object.create(i.prototype),f.prototype.url=function(e){var t=i.prototype.url.apply(this,arguments);if(arguments.length){for(var n in this._params)switch(n){case"Wuid":this.wuid(this._params[n]);break;case"ResultName":this.resultName(this._params[n]);break;case"Sequence":this.sequence(this._params[n])}if(!this._wuid){var r=this._url.split("/res/");if(r.length>=2){var s=r[1].split("/");this.wuid(s[0])}}}return t},f.prototype.wuid=function(e){return arguments.length?(this._wuid=e,this):this._wuid},f.prototype.jobname=function(e){return arguments.length?(this._jobname=e,this):this._jobname},f.prototype.sequence=function(e){return arguments.length?(this._sequence=e,this):this._sequence},f.prototype.resultName=function(e){return arguments.length?(this._resultName=e,this):this._resultName},f.prototype.appendParam=function(e,t,n){return t?(n&&(n+="&"),n+e+"="+t):n},f.prototype.constructUrl=function(){var e=i.prototype.getUrl.call(this,{pathname:"WsWorkunits/res/"+this._wuid+"/"}),t="";return t=this.appendParam("ResultName",this._resultName,t),e+(t?"?"+t:"")},f.prototype._fetchResult=function(e,n,r){e=e||{},e._start=e._start||0,e._count=e._count||-1;var i=this.getUrl({pathname:"WsWorkunits/WUResult.json"}),s={Wuid:e.wuid,ResultName:e.resultname,SuppressXmlSchema:!0,Start:e._start,Count:e._count};this._resultNameCache[e.resultname]={};var o=this;return this.jsonp(i,s).then(function(i){for(var s in i){if(!i[s].Result)throw"No result found.";o._total=i[s].Total,i=i[s].Result;for(var u in i){i=i[u].Row.map(t);break}break}return o._resultNameCache[e.resultname]=i,r||o._mappings.mapResult(o._resultNameCache,e.resultname),n&&(console.log("Deprecated:  callback, use promise (WsWorkunits.prototype._fetchResult)"),n(o._resultNameCache[e.resultname])),o._resultNameCache[e.resultname]})},f.prototype.fetchResult=function(e,t,n){if(e.wuid)return this._fetchResult(e,t,n);if(e.jobname){var r=this;return this.WUQuery(e,function(i){return e.wuid=i[0].Wuid,r._fetchResult(e,t,n)})}},f.prototype.WUQuery=function(e,t){var n=this.getUrl({pathname:"WsWorkunits/WUQuery.json"}),r={Jobname:r.jobname,Count:1};return this._resultNameCache={},this._resultNameCacheCount=0,this.jsonp(n,r).then(function(e){if(!s("WUQueryResponse.Workunits.ECLWorkunit",e))throw"No workunit found.";return e=e.WUQueryResponse.Workunits.ECLWorkunit,t&&(console.log("Deprecated:  callback, use promise (WsWorkunits.prototype.WUQuery)"),t(e)),e})},f.prototype.fetchResultNames=function(e){var t=this.getUrl({pathname:"WsWorkunits/WUInfo.json"}),n={Wuid:this._wuid,TruncateEclTo64k:!0,IncludeExceptions:!1,IncludeGraphs:!1,IncludeSourceFiles:!1,IncludeResults:!0,IncludeResultsViewNames:!1,IncludeVariables:!1,IncludeTimers:!1,IncludeResourceURLs:!1,IncludeDebugValues:!1,IncludeApplicationValues:!1,IncludeWorkflows:!1,IncludeXmlSchemas:!1,SuppressResultSchemas:!0};this._resultNameCache={},this._resultNameCacheCount=0;var r=this;return this.jsonp(t,n).then(function(t){return s("WUInfoResponse.Workunit.Results.ECLResult",t)&&t.WUInfoResponse.Workunit.Results.ECLResult.map(function(e){r._resultNameCache[e.Name]=[],++r._resultNameCacheCount}),e&&(console.log("Deprecated:  callback, use promise (WsWorkunits.prototype.fetchResultNames)"),e(r._resultNameCache)),r._resultNameCache})},f.prototype.fetchResults=function(e,t){var n=this;return this.fetchResultNames().then(function(r){var i=[];for(var s in n._resultNameCache)i.push(n.fetchResult({wuid:n._wuid,resultname:s},null,t));return Promise.all(i).then(function(t){return e&&(console.log("Deprecated:  callback, use promise (WsWorkunits.prototype.fetchResults)"),e(n._resultNameCache)),n._resultNameCache})})},f.prototype.postFilter=function(e,t){var n={};for(var r in t)n[r]=t[r].filter(function(t,n){for(var r in e)if(t[r]!==undefined&&e[r]!==undefined&&t[r]!=e[r])return!1;return!0});return this._mappings.mapResponse(n),n},f.prototype.send=function(e,t){var n=this;this._resultNameCacheCount?t(n.postFilter(e,this._resultNameCache)):this.fetchResults(function(r){t(n.postFilter(e,r))},!0)},l.prototype=Object.create(i.prototype),l.prototype.url=function(e){var t=i.prototype.url.apply(this,arguments);if(arguments.length)for(var n in this._params)switch(n){case"WUID":this.wuid(this._params[n])}return t},l.prototype.wuid=function(e){return arguments.length?(this._wuid=e,this):this._wuid},l.prototype.constructUrl=function(){return i.prototype.getUrl.call(this,{pathname:"WsWorkunits/WUGetStats?WUID="+this._wuid})},l.prototype.send=function(e,t){var n=this.getUrl({pathname:"WsWorkunits/WUGetStats.json?WUID="+this._wuid});return this.jsonp(n,e).then(function(e){return s("WUGetStatsResponse.Statistics.WUStatisticItem",e)?(t&&(console.log("Deprecated:  callback, use promise (WsWorkunits_GetStats.prototype.send)"),t(e.WUGetStatsResponse.Statistics.WUStatisticItem)),e.WUGetStatsResponse.Statistics.WUStatisticItem):(t&&(console.log("Deprecated:  callback, use promise (WsWorkunits_GetStats.prototype.send)"),t([])),[])})},c.prototype=Object.create(i.prototype),c.prototype.fetchResults=function(e,n){var r=this.getUrl({});this._resultNameCache={},this._resultNameCacheCount=0;var i=this;return this.jsonp(r,e).then(function(e){for(var r in e){e=e[r].Results;break}if(e.Exception)throw Error(e.Exception.reduce(function(e,t,n,r){return e.length&&(e+="\n"),e+t.Source+" "+t.Code+":  "+t.Message},""));for(r in e)e[r].Row&&(i._resultNameCache[r]=e[r].Row.map(t),++i._resultNameCacheCount);return n&&(console.log("Deprecated:  callback, use promise (HIPIERoxie.prototype.fetchResults)"),n(i._resultNameCache)),i._resultNameCache})},c.prototype.fetchResult=function(e,t){var n=this;return new Promise(function(r,i){t&&(console.log("Deprecated:  callback, use promise (HIPIERoxie.prototype.fetchResult)"),t(n._resultNameCache[e])),r(n._resultNameCache[e])})},c.prototype.call=function(e,t){return this.fetchResults(e,t)},h.prototype=Object.create(f.prototype),h.prototype.hipieResults=function(e){if(!arguments.length)return this._hipieResults;this._hipieResultsLength=0,this._hipieResults={};var t=this;return e.forEach(function(e){t._hipieResultsLength++,t._hipieResults[e.id]=e}),this},h.prototype.fetchResults=function(e){var t=this;return f.prototype.fetchResultNames.call(this).then(function(n){var r=[];for(var i in t._hipieResults){var s=t._hipieResults[i];r.push(t.fetchResult(s.from))}return Promise.all(r).then(function(n){return e&&(console.log("Deprecated:  callback, use promise (HIPIEWorkunit.prototype.fetchResults)"),e(t._resultNameCache)),t._resultNameCache})})},h.prototype.fetchResult=function(e,t){return f.prototype.fetchResult.call(this,{wuid:this._wuid,resultname:e}).then(function(e){return t&&(console.log("Deprecated:  callback, use promise (HIPIEWorkunit.prototype.fetchResult)"),t(e)),e})},h.prototype.call=function(e,t){if(e.refresh||!this._resultNameCache||!this._resultNameCacheCount)return this.fetchResults(t);var n=this;return new Promise(function(r,i){var s={};for(var o in e)e[o]!==undefined&&e[o+"_changed"]!==undefined&&(s[o]=e[o]);var u={};for(var a in n._hipieResults){var f=n._hipieResults[a],l=!0;for(var c in s)if(f.filter.indexOf(c)<0){l=!1;break}l&&(u[f.from]=n._resultNameCache[f.from].filter(function(e){for(var t in s)if(e[t]!=s[t]&&e[t.toLowerCase()]!=s[t])return!1;return!0}))}t&&(console.log("Deprecated:  callback, use promise (HIPIEWorkunit.prototype.call)"),t(u)),r(u)})},p.prototype=Object.create(h.prototype),p.prototype.databomb=function(e){return arguments.length?(this._databomb=e.map(t),this):this._databomb},p.prototype.databombOutput=function(e){return arguments.length?(this._resultNameCacheCount++,this._resultNameCache[e]=this._databomb,this):undefined},p.prototype.fetchResults=function(e){var t=this;return new Promise(function(n,r){e&&(console.log("Deprecated:  callback, use promise (HIPIEDatabomb.prototype.fetchResults)"),e(t._resultNameCache)),n(t._resultNameCache)})},{Basic:u,ESPMappings:r,ESPUrl:n,WsECL:a,WsWorkunits:f,HIPIERoxie:c,HIPIEWorkunit:h,HIPIEDatabomb:p,createESPConnection:function(e){e=e||document.URL;var t=(new n).url(e);return t.isWsWorkunits_GetStats()?(new l).url(e):t.isWsWorkunits()?(new f).url(e):t.isWsEcl()?(new a).url(e):null}}});