(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/HTMLWidget","../common/PropertyExt","../api/ITree","../common/Utility","css!./Treemap"],t):e.tree_Treemap=t(e.d3,e.common_HTMLWidget,e.common_PropertyExt,e.api_ITree,e.common_Utility)})(this,function(e,t,n,r,i){function s(e){n.call(this),this._owner=e}function o(e){t.call(this),r.call(this)}return s.prototype=Object.create(n.prototype),s.prototype.constructor=s,s.prototype._class+=" tree_Dendrogram.Column",s.prototype.publish("column",null,"set","Field",function(){return this._owner?this._owner.columns():[]},{optional:!0}),o.prototype=Object.create(t.prototype),o.prototype.constructor=o,o.prototype._class+=" tree_Treemap",o.prototype.implements(r.prototype),o.prototype.Column=s,o.prototype.publish("paletteID","default","set","Palette ID",o.prototype._palette.switch(),{tags:["Basic","Shared"]}),o.prototype.publish("useClonedPalette",!1,"boolean","Enable or disable using a cloned palette",null,{tags:["Intermediate","Shared"]}),o.prototype.publish("mappings",[],"propertyArray","Source Columns",null,{autoExpand:s}),o.prototype.publish("aggrType",null,"set","Aggregation Type",[null,"mean","median","sum","min","max"],{optional:!0}),o.prototype.publish("aggrColumn",null,"set","Aggregation Field",function(){return this.columns()},{optional:!0,disable:function(e){return!e.aggrType()}}),o.prototype.publish("fontSize",null,"number","Font Size",null,{optional:!0}),o.prototype.publish("transitionDuration",250,"number","Transition Duration"),o.prototype.treemapData=function(){function n(e){if(e.values instanceof Array){var t=e.values.filter(function(e){return!(e instanceof Array)}).map(function(e){return n(e)}),r={label:e.key};return t.length?r.children=t:r.size=22,r}return{label:e.key,size:e.values.aggregate,origRows:e.values}}if(!this.mappings().filter(function(e){return e.column()}).length)return this.data();var e=this._db.aggregateView(this.mappings().map(function(e){return e.column()}),this.aggrType(),this.aggrColumn()),t={key:"root",values:e.entries()};return n(t)},o.prototype.enter=function(n,r){t.prototype.enter.apply(this,arguments),this._d3Treemap=e.layout.treemap().value(function(e){return e.size||50}),this._elementDIV=r.append("div"),this._selection=new i.SimpleSelection(this._elementDIV)},o.prototype.update=function(e,n){function o(e){if(e.children)return null;var t=e.label+" ("+e.value+")";while(e.parent&&e.parent.parent)t=e.parent.label+" -> "+t,e=e.parent;return t}function u(e){this.style("left",function(e){return e.x+Math.max(0,e.dx-1)/2+"px"}).style("top",function(e){return e.y+Math.max(0,e.dy-1)/2+"px"}).style("width",function(e){return"0px"}).style("height",function(e){return"0px"})}function a(){this.style("left",function(e){return e.x+"px"}).style("top",function(e){return e.y+"px"}).style("width",function(e){return Math.max(0,e.dx-1)+"px"}).style("height",function(e){return Math.max(0,e.dy-1)+"px"})}t.prototype.update.apply(this,arguments),this._palette=this._palette.switch(this.paletteID()),this.useClonedPalette()&&(this._palette=this._palette.cloneNotExists(this.paletteID()+"_"+this.id()));var r=this._d3Treemap.size([this.width(),this.height()]).nodes(this.treemapData());this._elementDIV.style("font-size",this.fontSize_exists()?this.fontSize()+"px":null).style("line-height",this.fontSize_exists()?this.fontSize()+2+"px":null);var i=this,s=this._elementDIV.selectAll(".node").data(r);s.enter().append("div").attr("class","node").call(this._selection.enter.bind(this._selection)).on("click",function(e){if(e&&e.origRows){var t="";i.mappings().forEach(function(e){e.column()&&(t=e.column())}),i.click(i.rowToObj(e.origRows[0]),t,i._selection.selected(this))}}).call(u),s.attr("title",o).text(function(e){return e.children?null:e.label}).style("background",function(e){return e.children?i._palette(e.label):null}).transition().duration(this.transitionDuration()).style("opacity",function(e){return e.children?1:null}).call(a),s.exit().transition().duration(this.transitionDuration()).style("opacity",0).remove()},o.prototype.exit=function(e,n){t.prototype.exit.apply(this,arguments)},o});