(function(e,t){if(typeof define=="function"&&define.amd){var n=window.location.protocol==="https:"?"https:":"http:";define(["d3","../common/HTMLWidget","../layout/AbsoluteSurface","async!"+n+"//maps.google.com/maps/api/js","css!./GMap"],t)}else e.map_GMap=t(e.d3,e.common_HTMLWidget,e.layout_AbsoluteSurface)})(this,function(e,t,n){function r(e,t,n){google.maps.OverlayView.call(this),this._div=null,this._worldSurface=t,this._viewportSurface=n,this._map=e,this.setMap(e);var r=this;google.maps.event.addListener(e,"bounds_changed",function(){r.draw()}),google.maps.event.addListener(e,"projection_changed",function(){r.draw()}),this._prevWorldMin={x:0,y:0},this._prevWorldMax={x:0,y:0},this._prevMin={x:0,y:0},this._prevMax={x:0,y:0}}function i(){function r(t,n,r){var i=e._overlay.getProjection(),s=i.fromLatLngToDivPixel(new google.maps.LatLng(n,r)),o=i.getWorldWidth(),u=parseFloat(t.widgetX()),a=parseFloat(t.widgetY()),f=parseFloat(t.widgetWidth());s.x-=u,s.y-=a;while(s.x<0)s.x+=o;while(s.x>f)s.x-=o;return s}t.call(this),this._tag="div";var e=this;this._worldSurface=new n,this._worldSurface.project=function(e,t){return r(this,e,t)},this._viewportSurface=new n,this._viewportSurface.project=function(e,t){return r(this,e,t)}}return r.prototype=google.maps.OverlayView.prototype,r.prototype.onAdd=function(){this.div=document.createElement("div"),this._viewportSurface.target(this.div).units("pixels");var e=this.getPanes();e.overlayMouseTarget.appendChild(this.div)},r.prototype.draw=function(){var e=this.getProjection();if(!e)return;var t=this._map.getBounds(),n=e.fromLatLngToDivPixel(t.getCenter()),r=e.fromLatLngToDivPixel(t.getSouthWest()),i=e.fromLatLngToDivPixel(t.getNorthEast()),s={x:r.x,y:i.y},o={x:i.x,y:r.y},u=e.getWorldWidth();while(o.x<s.x+100)o.x+=u;while(s.x>n.x)s.x-=u,o.x-=u;if(s.x!==this._prevMin.x||s.y!==this._prevMin.y||o.x!==this._prevMax.x||o.y!==this._prevMax.y)this._viewportSurface.widgetX(s.x).widgetY(s.y).widgetWidth(o.x-s.x).widgetHeight(o.y-s.y).render(),this._prevMin=s,this._prevMax=o;var a=e.fromLatLngToDivPixel(new google.maps.LatLng(85,-179.9)),f=e.fromLatLngToDivPixel(new google.maps.LatLng(-85,179.9));while(f.x<a.x+100)f.x+=u;while(a.x>n.x)a.x-=u,f.x-=u;if(a.x!==this._prevWorldMin.x||a.y!==this._prevWorldMin.y||f.x!==this._prevWorldMax.x||f.y!==this._prevWorldMax.y)this._worldSurface.widgetX(a.x).widgetY(a.y).widgetWidth(f.x-a.x).widgetHeight(f.y-a.y).render(),this._prevWorldMin=f,this._prevWorldMax=f},r.prototype.onRemove=function(){this._viewportSurface.target(null),this._div.parentNode.removeChild(this._div),this._div=null},i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype._class+=" map_GMap",i.prototype.publish("type","road","set","Map Type",["terrain","road","satellite","hybrid"],{tags:["Basic"]}),i.prototype.publish("centerLat",42.877742,"number","Center Latitude",null,{tags:["Basic"]}),i.prototype.publish("centerLong",-97.380979,"number","Center Longtitude",null,{tags:["Basic"]}),i.prototype.publish("zoom",4,"number","Zoom Level",null,{tags:["Basic"]}),i.prototype.publish("panControl",!0,"boolean","Pan Controls",null,{tags:["Basic"]}),i.prototype.publish("zoomControl",!0,"boolean","Pan Controls",null,{tags:["Basic"]}),i.prototype.publish("mapTypeControl",!1,"boolean","Pan Controls",null,{tags:["Basic"]}),i.prototype.publish("scaleControl",!0,"boolean","Pan Controls",null,{tags:["Basic"]}),i.prototype.publish("streetViewControl",!1,"boolean","Pan Controls",null,{tags:["Basic"]}),i.prototype.publish("overviewMapControl",!1,"boolean","Pan Controls",null,{tags:["Basic"]}),i.prototype.data=function(e){var n=t.prototype.data.apply(this,arguments);return n},i.prototype.getMapType=function(){switch(this.type()){case"terrain":return google.maps.MapTypeId.TERRAIN;case"road":return google.maps.MapTypeId.ROADMAP;case"satellite":return google.maps.MapTypeId.SATELLITE;case"hybrid":return google.maps.MapTypeId.HYBRID;default:return google.maps.MapTypeId.ROADMAP}},i.prototype.getMapOptions=function(){return{panControl:this.panControl(),zoomControl:this.zoomControl(),mapTypeControl:this.mapTypeControl(),scaleControl:this.scaleControl(),streetViewControl:this.streetViewControl(),overviewMapControl:this.overviewMapControl(),overviewMapControlOptions:{opened:!0}}},i.prototype.size=function(e){var n=t.prototype.size.apply(this,arguments);return arguments.length&&this._googleMapNode&&(this._googleMapNode.style({width:e.width+"px",height:e.height+"px"}),google.maps.event.trigger(this._googleMap,"resize")),n},i.prototype.enter=function(n,i){t.prototype.enter.apply(this,arguments),this._googleMapNode=i.append("div").style({width:this.width()+"px",height:this.height()+"px"}),this._googleMap=new google.maps.Map(this._googleMapNode.node(),{zoom:this.zoom(),center:new google.maps.LatLng(this.centerLat(),this.centerLong()),mapTypeId:this.getMapType(),disableDefaultUI:!0}),this._overlay=new r(this._googleMap,this._worldSurface,this._viewportSurface),this._circleMap=e.map([]),this._pinMap=e.map([]),this._prevCenterLat=this.centerLat(),this._prevCenterLong=this.centerLong(),this._prevZoom=this.zoom()},i.prototype.update=function(e,t){this._googleMap.setMapTypeId(this.getMapType()),this._googleMap.setOptions(this.getMapOptions());if(this._prevCenterLat!==this.centerLat()||this._prevCenterLong!==this.centerLong())this._googleMap.setCenter(new google.maps.LatLng(this.centerLat(),this.centerLong())),this._prevCenterLat=this.centerLat(),this._prevCenterLong=this.centerLong();this._prevZoom!==this.zoom()&&(this._googleMap.setZoom(this.zoom()),this._prevZoom=this.zoom()),this.updateCircles(),this.updatePins()},i.prototype.updateCircles=function(){function t(e){return e[0]+"_"+e[1]}var n=[],r=[],i=e.map(this._circleMap.keys(),function(e){return e});this.data().forEach(function(e){i.remove(t(e)),e[3]&&!this._circleMap.has(t(e))?n.push(e):e[3]&&this._circleMap.has(t(e))?r.push(e):!e[3]&&this._circleMap.has(t(e))&&i.set(t(e),!0)},this),n.forEach(function(e){var n=this.createCircle(e[0],e[1],e[3],"");this._circleMap.set(t(e),n)},this),r.forEach(function(e){},this);var s=this;i.forEach(function(e){s._circleMap.get(e).setMap(null),s._circleMap.remove(e)})},i.prototype.updatePins=function(){function t(e){return e[0]+"_"+e[1]}var n=[],r=[],i=e.map(this._pinMap.keys(),function(e){return e});this.data().forEach(function(e){i.remove(t(e)),e[2]&&!this._pinMap.has(t(e))?n.push(e):e[2]&&this._pinMap.has(t(e))?r.push(e):!e[2]&&this._pinMap.has(t(e))&&i.set(t(e),!0)},this),n.forEach(function(e){var n=this.createMarker(e[0],e[1],e[2],"");this._pinMap.set(t(e),n)},this),r.forEach(function(e){this._pinMap.get(t(e)).setIcon(this.createIcon(e[2]))},this);var s=this;i.forEach(function(e){s._pinMap.get(e).setMap(null),s._pinMap.remove(e)})},i.prototype.createIcon=function(e){return{path:"M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30",fillColor:e.fillColor,fillOpacity:e.fillOpacity||.8,scale:.5,strokeColor:e.strokeColor||"black",strokeWeight:.25}},i.prototype.createMarker=function(e,t,n){return new google.maps.Marker({position:new google.maps.LatLng(e,t),animation:google.maps.Animation.DROP,title:n.title||"",icon:this.createIcon(n),map:this._googleMap})},i.prototype.createCircle=function(e,t,n){return new google.maps.Circle({center:new google.maps.LatLng(e,t),radius:16093*n.radius/10,fillColor:n.fillColor||"red",strokeColor:n.strokeColor||n.fillColor||"black",strokeWeight:.5,map:this._googleMap})},i.prototype.zoomTo=function(e){var t=0,n=new google.maps.LatLngBounds;return e.forEach(function(e){var r=new google.maps.LatLng(e[0],e[1]);n.extend(r),++t}),t&&(this._googleMap.setCenter(n.getCenter()),this._googleMap.fitBounds(n),this._googleMap.getZoom()>12&&this._googleMap.setZoom(12)),this},i.prototype.zoomToFit=function(){return this.zoomTo(this.data())},i});