(function(e,t){typeof define=="function"&&define.amd?define(["d3","./Class","./PropertyExt","./Utility"],t):e.common_Database=t(e.d3,e.common_Class,e.common_PropertyExt,e.common_Utility)})(this,function(e,t,n,r){function i(e,r){t.call(this),n.call(this),this._id=e||this._id,r=r||{},this.label(r.label||""),this.type(r.type||""),this.mask(r.mask||null),this.format(r.format||null)}function a(e){e=e||!1,t.call(this),n.call(this),this._dataChecksum=e,this._dataVersion=0,this.clear()}function l(t){this._grid=t,e.rebind(this,this._grid,"checksum","fields")}function c(e,t,n){l.call(this,e),t instanceof Array||(t=[t]),this._columnIndicies=t.filter(function(e){return e}).map(function(e){switch(typeof e){case"string":return this._grid.fieldByLabel(e).idx}return e},this),n=n||function(e){return e},this._rollup=n}function p(e,t){return e instanceof Array||(e=[e]),e.filter(function(e){return e!==""}).every(t)}function d(e){return typeof e=="boolean"}function v(e){return typeof e=="number"||!isNaN(e)}function m(e){return typeof e=="string"}function w(t,n){for(var r=0;r<t.length;++r){var i=e.time.format(t[r]).parse(n);if(i)return h=t[r],t[r]}return null}function E(e){return w(g,e)}function S(e){return w(y,e)}function x(e){return w(b,e)}function T(e){return["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","AS","DC","FM","GU","MH","MP","PW","PR","VI"].indexOf(String(e).toUpperCase())>=0}i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype.mixin(n),i.prototype._class+=" common_Database.Field",i.prototype.id=function(){return this._id},i.prototype.checksum=function(){return r.checksum(this.label()+this.type()+this.mask()+this.format())},i.prototype.publish("label","","string","Label"),i.prototype.publish("type","","set","Type",["","string","number","boolean","time"]);var s=i.prototype.type;i.prototype.type=function(e){var t=s.apply(this,arguments);if(arguments.length)switch(this.type()){case"number":this._typeTransformer=function(e){return Number(e)};break;case"string":this._typeTransformer=function(e){return String(e)};break;case"boolean":this._typeTransformer=function(e){return typeof e=="string"&&["false","off","0"].indexOf(e.toLowerCase())>=0?!1:Boolean(e)};break;case"time":case"date":this._typeTransformer=function(e){return this._maskTransformer.parse(e)};break;default:this._typeTransformer=function(e){return e}}return t},i.prototype.publish("mask","","string","Time Mask");var o=i.prototype.mask;i.prototype.mask=function(e){var t=o.apply(this,arguments);return arguments.length&&(this._maskTransformer=this.formatter(e)),t},i.prototype.publish("format","","string","Format");var u=i.prototype.format;i.prototype.format=function(e){var t=u.apply(this,arguments);return arguments.length&&(this._formatTransformer=this.formatter(e)),t},i.prototype.parse=function(e){if(!e)return e;try{return this._typeTransformer(e)}catch(t){return console.log("Unable to parse:  "+e),null}},i.prototype.transform=function(e){if(!e)return e;try{return this._formatTransformer(this._typeTransformer(e))}catch(t){return console.log("Unable to transform:  "+e),null}},i.prototype.clone=function(){return new i(this._id,{label:this.label(),type:this.type(),mask:this.mask(),format:this.format()})},i.prototype.formatter=function(t){var n;if(!t)return n=function(e){return e},n.parse=function(e){return e},n;switch(this.type()){case"time":case"date":return e.time.format(t)}return n=e.format(t),n.parse=function(e){return e},n},a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype.mixin(n),a.prototype._class+=" common_Database.Grid",a.prototype.publish("fields",[],"propertyArray","Fields"),a.prototype.clear=function(){return this.fields([]),this._data=[],this._dataChecksums=[],++this._dataVersion,this},a.prototype.legacyColumns=function(e){return arguments.length?(this.row(0,e),this):this.row(0)},a.prototype.legacyData=function(e,t){return a.prototype.data.apply(this,arguments)},a.prototype.field=function(e){return this.fields()[e]};var f=a.prototype.fields;a.prototype.fields=function(e,t){return arguments.length?f.call(this,t?e.map(function(e){return e.clone()}):e):f.apply(this,arguments)},a.prototype.fieldByLabel=function(e,t){return this.fields().filter(function(n,r){return n.idx=r,t?n.label().toLowerCase()===e.toLowerCase():n.label()===e})[0]},a.prototype.data=function(e,t){return arguments.length?(this._data=t?e.map(function(e){return e.map(function(e){return e})}):e,this._dataCalcChecksum(),this):this._data},a.prototype.parsedData=function(){var e=this;return this._data.map(function(t){return t.map(function(t,n){return e.fields()[n].parse(t)})})},a.prototype.formattedData=function(){var e=this;return this._data.map(function(t){return t.map(function(t,n){return e.fields()[n].transform(t)})})},a.prototype.fieldsChecksum=function(){return r.checksum(this.fields().map(function(e){return e.checksum()}))},a.prototype.dataChecksum=function(){return r.checksum(this._dataChecksum?this._dataChecksums:this._dataVersion)},a.prototype.checksum=function(){return r.checksum([this.dataChecksum(),this.fieldsChecksum()])},a.prototype._dataCalcChecksum=function(e){return++this._dataVersion,this._dataChecksum&&(arguments.length?this._dataChecksums[e]=r.checksum(this._data[e]):this._dataChecksums=this._data.map(function(e){return r.checksum(e)})),this},a.prototype.row=function(t,n){if(arguments.length<2)return t===0?this.fields().map(function(e){return e.label()}):this._data[t-1];if(t===0){var r=e.map(this.fields(),function(e){return e.label()});this.fields(n.map(function(e){return r.get(e)||(new i).label(e)},this))}else this._data[t-1]=n,this._dataCalcChecksum(t-1);return this},a.prototype.rows=function(e){return arguments.length?(this.row(0,e[0]),this._data=e.filter(function(e,t){return t>0}),this._dataCalcChecksum(),this):[this.row(0)].concat(this._data)},a.prototype.column=function(e,t){return arguments.length<2?[this.fields()[e].label()].concat(this._data.map(function(t,n){return t[e]})):(t.forEach(function(n,r){r===0?this.fields()[e]=(new i).label(t[0]):(this._data[r-1][e]=n,this._dataCalcChecksum(r-1))},this),this)},a.prototype.columnData=function(e,t){return arguments.length<2?this._data.map(function(t,n){return t[e]}):(t.forEach(function(t,n){this._data[n][e]=t,this._dataCalcChecksum(n)},this),this)},a.prototype.columns=function(e){return arguments.length?(e.forEach(function(t,n){this.column(n,e[n])},this),this):this.fields().map(function(e,t){return this.column(t)},this)},a.prototype.cell=function(e,t,n){return arguments.length<3?this.row(e)[t]:(e===0?this.fields()[t]=(new i).label(n):(this._data[e][t]=n,this._dataCalcChecksum(e)),this)},a.prototype.grid=function(e){return a.prototype.rows.apply(this,arguments)},a.prototype.hipieMapSortArray=function(e){return e.map(function(e){var t=!1;e.indexOf("-")===0&&(e=e.substring(1),t=!0);var n=this.fieldByLabel(e,!0);return n||console.log("Grid.prototype.hipieMapSortArray:  Invalid sort array - "+e),{idx:n?n.idx:-1,reverse:t}},this).filter(function(e){return e.idx>=0})},a.prototype.hipieMappings=function(t,n){function a(e,t,n,r){var i=n.map(function(e){return e});i[t]=e.key,e.values instanceof Array?e.values.forEach(function(e){a(e,t+1,i,r)}):(i[t+1]=e.values,r.push(i))}n=n||"";if(!this.fields().length||!this._data.length)return[];var r=-1,i=[],s=[],o=-1,u=[];t.forEach(function(e,t){if(e instanceof Object)switch(e.function){case"SUM":case"AVE":case"MIN":case"MAX":r>=0&&console.log("Rollup field already exists - there should only be one?"),r=t,e.params.forEach(function(e){var t=this.fieldByLabel(e.param1,!0);t?i.push(t.idx):console.log("Grid.prototype.hipieMappings:  Invalid rollup field - "+e.param1)},this);break;case"SCALE":o>=0&&console.log("Scale field already exists - there should only be one?"),o=t,e.params.forEach(function(e){var t=this.fieldByLabel(e.param1,!0);if(!t)console.log("Grid.prototype.hipieMappings:  Invalid scale field - "+e.param1);else{var n=t.idx,r=e.param2;u.push(function(e){return e[n]/r})}},this);break;default:console.log("Unknown field function - "+e.function)}else if(e.indexOf("_AVE")===e.length-4&&this.fieldByLabel(e.substring(0,e.length-4)+"_SUM",!0)&&this.fieldByLabel("base_count",!0)){console.log("Deprecated - Symposium AVE Hack");var a=this.fieldByLabel(e.substring(0,e.length-4)+"_SUM",!0),f=this.fieldByLabel("base_count",!0);s.push(a.idx),u.push(function(e){return e[a.idx]/e[f.idx]})}else{var l=this.fieldByLabel(e,!0);l?(s.push(l.idx),u.push(function(e){return e[l.idx]})):(console.log("Unable to locate '"+e+"' in server response."),u.push(function(e){return n}))}},this);if(r>=0){var f=t[r],l=[];for(var c in f.params)l.push(f.params[c]);var h=this.rollup(s,function(t){switch(f.function){case"SUM":return e.sum(t,function(e){return e[i[0]]});case"AVE":return e.mean(t,function(e){return e[i[0]]});case"MIN":return e.min(t,function(e){return e[i[0]]});case"MAX":return e.max(t,function(e){return e[i[0]]})}return console.log("Unsupported Mapping Function:  "+f.function),0}),p=[];return h instanceof Array?h.forEach(function(e){a(e,0,[],p)}):p.push([h]),p}return this._data.map(function(e){var t=[];return u.forEach(function(n){t.push(n(e))}),t})},l.prototype.constructor=l,l.prototype.grid=function(){return this._grid},l.prototype.columns=function(e){return arguments.length?(this._grid.legacyColumns(e),this):this._grid.legacyColumns()},l.prototype.rawData=function(e){return arguments.length?(this._grid.legacyData(e),this):this._grid.legacyData()},l.prototype.formattedData=function(){return this._formattedDataChecksum!==this._grid.checksum()&&(this._formattedDataChecksum=this._grid.checksum(),this._formattedData=this._grid.formattedData()),this._formattedData},l.prototype.parsedData=function(){return this._parsedDataChecksum!==this._grid.checksum()&&(this._parsedDataChecksum=this._grid.checksum(),this._parsedData=this._grid.parsedData()),this._parsedData},l.prototype._whichData=function(e){if(e){if(e.parsed)return this.formattedData();if(e.formatted)return this.formattedData()}return this.rawData()},l.prototype.data=function(e){return l.prototype.rawData.apply(this,arguments)},c.prototype=Object.create(l.prototype),c.prototype.constructor=c,c.prototype.nest=function(){if(this._nestChecksum!==this._grid.checksum()){this._nestChecksum=this._grid.checksum();var t=e.nest();this._columnIndicies.forEach(function(e){t.key(function(t){return t[e]})}),this._nest=t.rollup(this._rollup)}return this._nest},c.prototype.entries=function(e){return this.nest().entries(this._whichData(e))},c.prototype.map=function(e){return this.nest().map(this._whichData(e))},c.prototype.d3Map=function(t){return this.nest().map(this._whichData(t),e.map)},c.prototype._walkData=function(e,t){t=t||[];var n=[];return e.forEach(function(e){e instanceof Array?n.push(t.concat([e])):n=n.concat(this._walkData(e.values,t.concat([e.key])))},this),n},c.prototype.data=function(e){return this._walkData(this.entries(e))},a.prototype.legacyView=function(){return new l(this)},a.prototype.nestView=function(e){return new c(this,e)},a.prototype.rollupView=function(e,t){return new c(this,e,t)},a.prototype.aggregateView=function(t,n,r,i){var s=this;return new c(this,t,function(t){switch(n){case null:case undefined:case"":return t.aggregate=t.length,t;default:var o=s.legacyColumns(),u=o.indexOf(r),a=o.indexOf(i);return t.aggregate=e[n](t,function(e){return(+e[u]-(a>=0?+e[a]:0))/(a>=0?+e[a]:1)}),t}})},a.prototype._nest=function(t,n){t instanceof Array||(t=[t]);var r=e.nest();return t.forEach(function(e){r.key(function(t){return t[e]})}),r},a.prototype.nest=function(e){return this._nest(e).entries(this._data)},a.prototype.rollup=function(e,t){return this._nest(e).rollup(t).entries(this._data)},a.prototype.length=function(){return this._data.length+1},a.prototype.width=function(){return this.fields().length},a.prototype.pivot=function(){return this.rows(this.columns()),this},a.prototype.clone=function(e){return(new a).fields(this.fields(),e).data(this.data(),e)},a.prototype.filter=function(e){var t={};return this.row(0).forEach(function(e,n){t[e]=n}),(new a).fields(this.fields(),!0).data(this.data().filter(function(n){for(var r in e)if(e[r]!==n[t[r]])return!1;return!0}))};var h=null;a.prototype.analyse=function(e){e instanceof Array||(e=[e]);var t=[];return e.forEach(function(e){var n=this.rollup(e,function(e){return e.length});t.push(n);var r=n.map(function(e){return e.key});this.fields()[e].isBoolean=p(r,d),this.fields()[e].isNumber=p(r,v),this.fields()[e].isString=!this.fields()[e].isNumber&&p(r,m),this.fields()[e].isUSState=this.fields()[e].isString&&p(r,T),this.fields()[e].isDateTime=this.fields()[e].isString&&p(r,E),this.fields()[e].isDateTimeFormat=h,this.fields()[e].isDate=!this.fields()[e].isDateTime&&p(r,S),this.fields()[e].isDateFormat=h,this.fields()[e].isTime=this.fields()[e].isString&&!this.fields()[e].isDateTime&&!this.fields()[e].isDate&&p(r,x),this.fields()[e].isTimeFormat=h},this),t},a.prototype.jsonObj=function(e){return arguments.length?(this.clear(),this.data(e.map(function(e,t){var n=[];for(var r in e){var s=this.row(0).indexOf(r);s<0&&(s=this.fields().length,this.fields().push((new i).label(r))),n[s]=e[r]}return n},this)),this):this._data.map(function(e){var t={};return this.row(0).forEach(function(n,r){t[n]=e[r]}),t},this)},a.prototype.json=function(e){return arguments.length?(this.jsonObj(JSON.parse(e)),this):JSON.stringify(this.jsonObj(),null,"  ")},a.prototype.csv=function(t){return arguments.length?(this.jsonObj(e.csv.parse(t)),this):e.csv.formatRows(this.grid())},a.prototype.tsv=function(t){return arguments.length?(this.jsonObj(e.tsv.parse(t)),this):e.tsv.formatRows(this.grid())};var g=[],y=["%Y-%m-%d","%Y%m%d"],b=["%H:%M:%S.%LZ","%H:%M:%SZ","%H:%M:%S"];return y.forEach(function(e){b.forEach(function(t){g.push(e+"T"+t)})}),{Field:i,Grid:a}});